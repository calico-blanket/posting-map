# プロジェクト経過報告: ポスティング管理マップ

## プロジェクト概要
ポスティング（チラシ配布）活動を支援するための地図アプリ開発。
**技術スタック:** Next.js 16 (App Router), Firebase (Auth, Firestore), Leaflet (React-Leaflet), Tailwind CSS, Vercel.

## 開発ロードマップとマイルストーン

### 1. 初期セットアップと基本機能
- Next.js + TypeScript プロジェクトの立ち上げ。
- **Firebase Authentication** の導入（Googleログイン）。
- **Leaflet Map** の導入と、図形描画機能 (`leaflet-draw`) の実装。
- **課題:** Firestoreは「配列の配列（GeoJSONの座標データ）」を直接保存できない制約があった。
- **解決策:** データ保存時に座標データを適切な形式に変換（シリアライズ）する仕組みを作成して解決。

### 2. 地図とUI機能の実装
- 「現在地を表示する」機能の追加。
- アプリ起動時に、自動的に現在地中心に地図を表示するように改善。
- ポップアップ内に「エリア編集フォーム (`AreaEditForm`)」を作成。ステータス（予定・完了・中止）とメモを管理可能に。
- **課題:** ボタンを押したときに、裏にある地図までクリックされてしまう問題。
- **解決策:** `e.stopPropagation()` をイベントに適用して、クリック操作が地図に伝わらないように修正。

### 3. PWA（スマホアプリ化）対応
- `next-pwa` を導入し、スマホのホーム画面にインストール可能に設定。
- `manifest.json` を作成し、アプリアイコンやテーマカラーを設定。
- **課題:** Next.js 16の標準ビルドツール (Turbopack) が `next-pwa` と競合してエラーが発生。
- **解決策:** `package.json` でビルド設定を `next build --webpack` に変更し、従来のWebpackを使うことで解決。

### 4. デプロイとセキュリティ設定
- **Vercel** への本番公開（デプロイ）。
- 環境変数 (`.env.local`) の設定。
- **課題:** 本番環境で「データベースへのアクセス拒否」エラーが発生。
- **解決策:** Firestoreのセキュリティルールを更新し、Firebase管理画面でVercelのドメインを許可リストに追加。

### 5. デザインとブランディング
- AI画像生成を使用し、オリジナルのアプリアイコン（ミントグリーン＋黄色ピン）を作成・適用。
- アプリ全体のテーマカラーを「青」から、チームカラーの「ティール（青緑）」に統一。

### 6. その他
- デモ動画の自動撮影を試行したが、ブラウザ操作の安定性を優先し、コードを本番用の状態に復元・整理。
- Gitリポジトリを初期化し、ソースコード管理を確立。

### 7. データ管理機能（バックアップ・復元）
- **バックアップ機能:** アプリ上の設定ボタンから、全配布エリアのデータをJSONファイルとして一括ダウンロードする機能を実装。
- **復元（インポート）機能:** バックアップファイルを読み込み、データベース上の既存データを削除した上で、バックアップ時点の状態に完全に復元する機能を実装。
- **課題:** Vercel本番環境でのビルド時に、モジュールのインポート設定ミスによるビルドエラーが発生。
- **解決策:** 不要なインポートを削除し、ローカルで本番用ビルド (`npm run build`) を確認してから再デプロイを実施。

### 8. ゲストログイン（匿名認証）機能
- **目的:** Googleアカウントを持っていないユーザーでも地図の作成・共有に参加できるようにする。
- **実装:** Firebase Authenticationの「匿名ログイン」を採用。ログイン画面に「ゲストとして利用」ボタンを追加。
- **課題:** 実装後に「Guest login failed」エラーが発生。
- **解決策:** Firebaseコンソールで「匿名」プロバイダが無効になっていたため、有効化することで解決。

## 現在の状況 (2025/12/29 追記)
- **状態:** 機能実装完了、Vercelにて稼働中、スマホインストール可能。
- **URL:** [Vercel Deployment URL]
- **次のステップ:** 詳細な計画については [ROADMAP.md](./ROADMAP.md) を参照してください。
    - **フェーズ 1:** セキュリティと品質の担保 (ユーザー制限、CI/CD)。
    - **フェーズ 2:** データ管理機能の拡張 (CSVエクスポート/インポート)。
    - **フェーズ 3:** 配布・導入の簡略化 (PWA強化、簡単デプロイ)。

### 9. EXIFデバッグとUI改善 (2025/1/4 追記)
- **モバイルEXIF問題の解決:**
    - **問題:** モバイル端末（特にAndroid Chrome）でアップロードした写真から位置情報が取得できず、座標がnullになる問題が発生。
    - **原因:** アプリのコード以前に、Android Chromeの「新しい写真ピッカー」や「最近の画像」ショートカットから選択すると、プライバシー機能によりブラウザレベルでEXIF（位置情報）が削除される仕様であった。
    - **対応:**
        - ライブラリを `exifr` から、より互換性の高い `exif-js` に変更（PC環境含めた安定性向上のため）。
        - ユーザー運用として「ファイル参照」→「ギャラリー/Googleフォト」から選択する回避策を確立。
        - デバッグ用に一時追加していたアラート機能を削除し、本番用にクリーンアップ。
- **UI改善:**
    - **カメラボタン:** モバイル画面下部で見切れないよう、配置位置を底面から80px上に移動し、サイズを微調整。
    - **現在地ボタン:** 左下の「Currently」ボタンも同様に、カメラボタンと高さを合わせて配置変更。
- **新機能:**
    - **詳細情報表示:** ピンをタップした際、ポップアップ内のメモ欄の下に、その場所の緯度経度（小数点以下6桁）を表示するように追加。
- **データ容量見積もり:**
    - 現在の無料プラン構成（Firestore 1GB）で、写真付きデータで約2,500〜5,000件程度まで保存可能と算出。個人利用には十分であることを確認。
